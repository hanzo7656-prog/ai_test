name: ğŸš€ Keep Render Service Alive

on:
  schedule:
    - cron: '*/10 * * * *'
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SERVICE_URL: ${{ secrets.SERVICE_URL }}           # ğŸ”½ Ø§ÛŒÙ†Ø¬Ø§ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Check Basic Health
        run: |
          echo "ğŸ• Starting health check..."
          echo "ğŸ”— Service URL: $SERVICE_URL"        # Ù„Ø§Ú¯ Ù†Ø´ÙˆÙ† Ù…ÛŒØ¯Ù‡ ÙˆÙ„ÛŒ Ø§Ù…Ù† Ù…ÙˆÙ†Ø¯Ù‡
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" "$SERVICE_URL/api/health/ping")
          http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d':' -f2)
          
          if [ "$http_status" -eq 200 ]; then
            echo "âœ… Basic health check passed"
          else
            echo "âŒ Basic health check failed: HTTP $http_status"
            
            # Ø§Ø±Ø³Ø§Ù„ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø·Ø§ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… (Ø¨Ø¯ÙˆÙ† Ù†Ø´ÙˆÙ† Ø¯Ø§Ø¯Ù† URL Ú©Ø§Ù…Ù„)
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸš¨ SERVICE DOWN! 
ğŸ’» Vortex AI Service
âŒ HTTP Status: $http_status
â° Time: $(date +'%Y-%m-%d %H:%M:%S')
ğŸ“¡ Action required!"
            exit 1
          fi

      - name: ğŸ“Š Check Full Health Status
        run: |
          echo "ğŸ” Checking full health status..."
          
          response=$(curl -s "$SERVICE_URL/api/health/status")
          health_score=$(echo "$response" | grep -o '"health_score":[0-9]*' | cut -d':' -f2)
          status=$(echo "$response" | grep -o '"status":"[^"]*' | cut -d'"' -f4)
          
          echo "âœ… Full health check passed"
          echo "ğŸ“ˆ Health Score: $health_score"
          echo "ğŸ”„ Status: $status"
          
          # Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ø³Ù„Ø§Ù…Øª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
          if [ "$health_score" -lt 70 ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="âš ï¸ SERVICE DEGRADED! 
ğŸ’» Vortex AI Service
ğŸ“Š Health Score: $health_score%
ğŸ”¶ Status: $status
â° Time: $(date +'%H:%M')
ğŸ”§ Check required!"
          fi

      - name: ğŸ‰ Send Success Notification
        if: success()
        run: |
          echo "âœ… All health checks passed"
          
          # ÙÙ‚Ø· Ø§ÙˆÙ„ÛŒÙ† Ø§Ø¬Ø±Ø§ÛŒ ØµØ¨Ø­ Ú¯Ø²Ø§Ø±Ø´ Ù…ÙˆÙÙ‚ÛŒØª Ø¨ÙØ±Ø³Øª
          if [ $(date +%H) -eq 09 ] && [ $(date +%M) -lt 10 ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="âœ… VORTEX AI - ALL SYSTEMS GO! 
ğŸ“Š Status: Healthy & Responsive
ğŸ•’ Last Check: $(date +'%H:%M')
ğŸ‰ Automated monitoring active!"
          fi
