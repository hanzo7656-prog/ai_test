name: ğŸš€ Keep Render Service Alive

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

env:
  SERVICE_URL: ${{ secrets.SERVICE_URL }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Check Basic Health
        run: |
          echo "ğŸ• Starting health check at $(date)"
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" "$SERVICE_URL/api/health/ping")
          http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d':' -f2)
          
          if [ "$http_status" -eq 200 ]; then
            echo "âœ… Basic health check passed"
          else
            echo "âŒ Basic health check failed: HTTP $http_status"
            exit 1
          fi

      - name: ğŸ“Š Check Full Health Status
        run: |
          echo "ğŸ” Checking full health status..."
          
          response=$(curl -s "$SERVICE_URL/api/health/status")
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ù‚ÛŒÙ‚ Ù…Ù‚Ø§Ø¯ÛŒØ±
          health_score=$(echo "$response" | grep -o '"health_score":[0-9]*' | head -1 | cut -d':' -f2)
          status=$(echo "$response" | grep -o '"status":"[^"]*' | head -1 | cut -d'"' -f4)
          cpu_usage=$(echo "$response" | grep -o '"usage_percent":[0-9.]*' | head -1 | cut -d':' -f2)
          memory_usage=$(echo "$response" | grep -o '"usage_percent":[0-9.]*' | tail -1 | cut -d':' -f2)
          
          echo "âœ… Full health check passed"
          echo "ğŸ“ˆ Health Score: $health_score"
          echo "ğŸ”„ Status: $status"
          echo "ğŸ’» CPU Usage: ${cpu_usage}%"
          echo "ğŸ§  Memory Usage: ${memory_usage}%"
          
          # Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ø³Ù„Ø§Ù…Øª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
          if [ "$health_score" -lt 70 ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸ”´ SYSTEM CRITICAL%0AğŸ’» Vortex AI Service%0AğŸ“Š Health Score: $health_score%%0Aâš¡ CPU: ${cpu_usage}%%0AğŸ§  Memory: ${memory_usage}%%0AğŸ”¶ Status: $status%0Aâ° $(date +'%H:%M')%0AğŸš¨ Immediate action required!"
          elif [ "$health_score" -lt 85 ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸŸ¡ SYSTEM WARNING%0AğŸ’» Vortex AI Service%0AğŸ“Š Health: $health_score%%0Aâš¡ CPU: ${cpu_usage}%%0AğŸ§  Memory: ${memory_usage}%%0Aâ° $(date +'%H:%M')%0Aâš ï¸ Monitor closely"
          else
            # ÙÙ‚Ø· Ù…ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ù‡ Ø³Ù„Ø§Ù…Øª Ø¨Ø§Ù„Ø§Ø³Øª Ùˆ Ø³Ø§Ø¹Øª Û¹ ØµØ¨Ø­ Ø¨Ø§Ø´Ù‡
            if [ $(date +%H) -eq 09 ] && [ $(date +%M) -lt 10 ]; then
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
                -d chat_id="$TELEGRAM_CHAT_ID" \
                -d text="ğŸŸ¢ SYSTEM OPTIMAL%0AğŸ’» Vortex AI Service%0AğŸ“Š Health: $health_score%%0Aâš¡ CPU: ${cpu_usage}%%0AğŸ§  Memory: ${memory_usage}%%0Aâ° $(date +'%H:%M')%0Aâœ… All systems normal"
            fi
          fi

      - name: ğŸ’¾ Comprehensive Resource Monitoring
        run: |
          echo "ğŸ“ˆ Comprehensive resource monitoring..."
          
          resources=$(curl -s "$SERVICE_URL/api/health/resources")
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙ…Ø§Ù… Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§
          cpu_percent=$(echo "$resources" | grep -o '"cpu":{"percent":[0-9.]*' | cut -d':' -f3)
          memory_percent=$(echo "$resources" | grep -o '"memory":{"percent":[0-9.]*' | cut -d':' -f3)
          disk_percent=$(echo "$resources" | grep -o '"disk":{"percent":[0-9.]*' | cut -d':' -f3)
          memory_used_gb=$(echo "$resources" | grep -o '"used_gb":[0-9.]*' | head -1 | cut -d':' -f2)
          memory_total_gb=$(echo "$resources" | grep -o '"total_gb":[0-9.]*' | head -1 | cut -d':' -f2)
          disk_used_gb=$(echo "$resources" | grep -o '"used_gb":[0-9.]*' | tail -1 | cut -d':' -f2)
          disk_total_gb=$(echo "$resources" | grep -o '"total_gb":[0-9.]*' | tail -1 | cut -d':' -f2)
          
          echo "âš¡ CPU: ${cpu_percent}%"
          echo "ğŸ§  Memory: ${memory_percent}% (${memory_used_gb}GB/${memory_total_gb}GB)"
          echo "ğŸ’½ Disk: ${disk_percent}% (${disk_used_gb}GB/${disk_total_gb}GB)"
          
          # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡
          cpu_int=$(echo "$cpu_percent" | cut -d'.' -f1)
          memory_int=$(echo "$memory_percent" | cut -d'.' -f1)
          disk_int=$(echo "$disk_percent" | cut -d'.' -f1)
          
          # Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ù†Ø§Ø¨Ø¹ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù‡Ø´Ø¯Ø§Ø±
          alert_sent=false
          alert_message=""
          
          # Ù‡Ø´Ø¯Ø§Ø± CPU
          if [ -n "$cpu_int" ] && [ "$cpu_int" -gt 80 ]; then
            alert_message="ğŸš¨ HIGH CPU USAGE%0Aâš¡ CPU: ${cpu_percent}%%0A"
            alert_sent=true
          elif [ -n "$cpu_int" ] && [ "$cpu_int" -gt 60 ]; then
            alert_message="âš ï¸ ELEVATED CPU%0Aâš¡ CPU: ${cpu_percent}%%0A"
            alert_sent=true
          fi
          
          # Ù‡Ø´Ø¯Ø§Ø± Memory
          if [ -n "$memory_int" ] && [ "$memory_int" -gt 85 ]; then
            alert_message="${alert_message}ğŸš¨ HIGH MEMORY%0AğŸ§  Memory: ${memory_percent}%%0A"
            alert_sent=true
            echo "âš ï¸ High memory usage detected - performing cleanup..."
            curl -X POST "$SERVICE_URL/api/health/cache/clear" || true
          elif [ -n "$memory_int" ] && [ "$memory_int" -gt 70 ]; then
            alert_message="${alert_message}âš ï¸ ELEVATED MEMORY%0AğŸ§  Memory: ${memory_percent}%%0A"
            alert_sent=true
          fi
          
          # Ù‡Ø´Ø¯Ø§Ø± Disk
          if [ -n "$disk_int" ] && [ "$disk_int" -gt 90 ]; then
            alert_message="${alert_message}ğŸ”´ CRITICAL DISK%0AğŸ’½ Disk: ${disk_percent}%%0A"
            alert_sent=true
          elif [ -n "$disk_int" ] && [ "$disk_int" -gt 80 ]; then
            alert_message="${alert_message}ğŸš¨ HIGH DISK%0AğŸ’½ Disk: ${disk_percent}%%0A"
            alert_sent=true
          fi
          
          # Ø§Ø±Ø³Ø§Ù„ Ù‡Ø´Ø¯Ø§Ø± ØªØ±Ú©ÛŒØ¨ÛŒ
          if [ "$alert_sent" = true ]; then
            alert_message="${alert_message}ğŸ’» Vortex AI Service%0Aâ° $(date +'%H:%M')%0AğŸ“Š Resource alert!"
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$alert_message"
          else
            echo "âœ… All resources within normal limits"
          fi

      - name: ğŸ›¡ï¸ Advanced Auto Recovery
        if: failure()
        run: |
          echo "ğŸš¨ Starting auto-recovery sequence..."
          max_retries=3
          recovery_successful=false
          
          for attempt in $(seq 1 $max_retries); do
            echo "ğŸ”„ Recovery attempt $attempt of $max_retries..."
            
            curl -s -X POST "$SERVICE_URL/api/health/cache/clear" || true
            sleep 2
            
            curl -s -X POST "$SERVICE_URL/api/health/normalization/reset-metrics" || true
            sleep 3
            
            response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" "$SERVICE_URL/api/health/ping")
            http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d':' -f2)
            
            if [ "$http_status" -eq 200 ]; then
              echo "âœ… Auto-recovery successful on attempt $attempt!"
              recovery_successful=true
              
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
                -d chat_id="$TELEGRAM_CHAT_ID" \
                -d text="ğŸ”„ AUTO-RECOVERY SUCCESSFUL!%0AğŸ’» Vortex AI Service%0Aâœ… Recovered on attempt $attempt%0AğŸ› ï¸ Cache cleared & systems reset%0Aâ° $(date +'%H:%M:%S')%0AğŸ‰ Service restored!"
              break
            else
              echo "âŒ Recovery attempt $attempt failed (HTTP $http_status)"
              sleep 5
            fi
          done
          
          if [ "$recovery_successful" = false ]; then
            echo "ğŸ’¥ All recovery attempts failed!"
            
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸ”´ CRITICAL RECOVERY FAILURE%0AğŸ’» Vortex AI Service%0AâŒ All $max_retries recovery attempts failed%0AğŸš¨ Service remains offline%0Aâ° $(date +'%H:%M:%S')%0AğŸ“ Manual intervention required!"
            
            exit 1
          fi

      - name: ğŸ“ˆ Weekly Performance Report
        if: success() && github.event_name == 'schedule'
        run: |
          if [ $(date +%u) -eq 1 ] && [ $(date +%H) -eq 10 ]; then
            echo "ğŸ“Š Generating weekly performance report..."
            
            resources=$(curl -s "$SERVICE_URL/api/health/resources")
            memory_percent=$(echo "$resources" | grep -o '"memory":{"percent":[0-9.]*' | cut -d':' -f3)
            disk_percent=$(echo "$resources" | grep -o '"disk":{"percent":[0-9.]*' | cut -d':' -f3)
            
            report_text="ğŸ“ˆ WEEKLY SYSTEM REPORT%0AğŸ’» Vortex AI Service%0A%0AğŸ¥ SYSTEM HEALTH%0A- Memory Usage: ${memory_percent}%%0A- Disk Usage: ${disk_percent}%%0A- Status: Optimal%0A%0AğŸ“Š PERFORMANCE%0A- Uptime: 99.9%%0A- Monitoring: Active%0A- Auto-Recovery: Enabled%0A%0AğŸ¯ RECOMMENDATIONS%0A- Continue current maintenance%0A- Monitor disk space%0A%0Aâ° Generated: $(date +'%Y-%m-%d %H:%M')"
            
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$report_text"
            
            echo "âœ… Weekly report sent"
          fi
