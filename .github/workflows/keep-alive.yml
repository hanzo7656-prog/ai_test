name: ğŸš€ Keep Render Service Alive

on:
  schedule:
    - cron: '*/10 * * * *'  # Ù‡Ø± Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SERVICE_URL: ${{ secrets.SERVICE_URL }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Check Basic Health
        id: health_check
        run: |
          echo "ğŸ• Starting health check at $(date)"
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" "$SERVICE_URL/api/health/ping")
          http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d':' -f2)
          
          if [ "$http_status" -eq 200 ]; then
            echo "âœ… Basic health check passed"
          else
            echo "âŒ Basic health check failed: HTTP $http_status"
            exit 1
          fi

      - name: ğŸ“Š Check Full Health Status
        run: |
          echo "ğŸ” Checking full health status..."
          
          response=$(curl -s "$SERVICE_URL/api/health/status")
          health_score=$(echo "$response" | grep -o '"health_score":[0-9]*' | cut -d':' -f2)
          status=$(echo "$response" | grep -o '"status":"[^"]*' | cut -d'"' -f4)
          cpu_usage=$(echo "$response" | grep -o '"usage_percent":[0-9.]*' | head -1 | cut -d':' -f2)
          memory_usage=$(echo "$response" | grep -o '"usage_percent":[0-9.]*' | tail -1 | cut -d':' -f2)
          
          echo "âœ… Full health check passed"
          echo "ğŸ“ˆ Health Score: $health_score"
          echo "ğŸ”„ Status: $status"
          
          # Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ø³Ù„Ø§Ù…Øª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
          if [ "$health_score" -lt 70 ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="âš ï¸ SERVICE DEGRADED%0AğŸ’» Vortex AI Service%0AğŸ“Š Health Score: $health_score%%0AğŸ”¶ Status: $status%0AğŸ’» CPU: ${cpu_usage}%%20|%20ğŸ§  Memory: ${memory_usage}%%0Aâ° Time: $(date +'%H:%M')%0AğŸ”§ Check required!"
          elif [ "$health_score" -lt 85 ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸ”¸ Service Warning%0AğŸ’» Vortex AI Service%0AğŸ“Š Health: $health_score%%0AğŸ’» CPU: ${cpu_usage}%%20|%20ğŸ§  Memory: ${memory_usage}%%0Aâ° $(date +'%H:%M')"
          fi

      - name: ğŸ’¾ Smart Memory Management
        run: |
          echo "ğŸ§  Checking memory usage..."
          
          resources=$(curl -s "$SERVICE_URL/api/health/resources")
          memory_usage=$(echo "$resources" | grep -o '"memory_percent":[0-9.]*' | cut -d':' -f2)
          cache_stats=$(curl -s "$SERVICE_URL/api/health/cache/stats")
          cache_size=$(echo "$cache_stats" | grep -o '"total_size_mb":[0-9.]*' | cut -d':' -f2) || cache_size="0"
          
          echo "ğŸ’¾ Memory Usage: ${memory_usage}%"
          echo "ğŸ“¦ Cache Size: ${cache_size}MB"
          
          # Ø§Ú¯Ø± Ø­Ø§ÙØ¸Ù‡ Ø¨Ø§Ù„Ø§ Ø¨ÙˆØ¯ØŒ Ø§Ù‚Ø¯Ø§Ù… Ú©Ù†
          if (( $(echo "$memory_usage > 75" | bc -l) )); then
            echo "âš ï¸ High memory usage detected - performing cleanup..."
            
            # Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ú©Ø´
            curl -X POST "$SERVICE_URL/api/health/cache/clear" || true
            
            # Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ú©Ø´ Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ
            curl -X POST "$SERVICE_URL/api/health/normalization/clear-cache" || true
            
            # Ú¯Ø²Ø§Ø±Ø´ Ø§Ù‚Ø¯Ø§Ù…
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸ§¹ MEMORY CLEANUP PERFORMED!%0AğŸ’» Vortex AI Service%0AğŸ“Š Memory Usage: ${memory_usage}%%0AğŸ“¦ Cache Cleared: ${cache_size}MB%0AğŸ•’ Time: $(date +'%H:%M')%0Aâœ… System optimized"
          fi

      - name: ğŸŒ IP & Security Checkup
        run: |
          echo "ğŸ›¡ï¸ Performing security checkup..."
          
          # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ
          security_report=$(curl -s "$SERVICE_URL/api/health/debug/security/overview") || security_report="{}"
          recent_ips=$(curl -s "$SERVICE_URL/api/health/debug/security/recent-ips") || recent_ips="{}"
          
          # Ø¨Ø±Ø±Ø³ÛŒ IPÙ‡Ø§ÛŒ Ù…Ø´Ú©ÙˆÚ©
          suspicious_ips=$(echo "$recent_ips" | grep -o '"suspicious":[0-9]*' | cut -d':' -f2) || suspicious_ips=0
          
          if [ "$suspicious_ips" -gt 0 ]; then
            echo "ğŸš¨ Suspicious activity detected: $suspicious_ips IPs"
            
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸš¨ SECURITY ALERT!%0AğŸ’» Vortex AI Service%0AğŸ” Suspicious IPs: $suspicious_ips%0AğŸŒ Recent activity detected%0AğŸ•’ Time: $(date +'%H:%M')%0AğŸ”’ Review security logs"
          else
            echo "âœ… No security issues detected"
          fi

      - name: ğŸ›¡ï¸ Advanced Auto Recovery
        if: failure()
        run: |
          echo "ğŸš¨ Starting auto-recovery sequence..."
          max_retries=3
          recovery_successful=false
          
          for attempt in $(seq 1 $max_retries); do
            echo "ğŸ”„ Recovery attempt $attempt of $max_retries..."
            
            # Û±. Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ú©Ø´
            echo "ğŸ§¹ Clearing cache..."
            curl -s -X POST "$SERVICE_URL/api/health/cache/clear" || true
            sleep 2
            
            # Û². Ø±ÛŒØ³Øª Ø³ÛŒØ³ØªÙ… Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ
            echo "ğŸ”„ Resetting normalization..."
            curl -s -X POST "$SERVICE_URL/api/health/normalization/reset-metrics" || true
            sleep 3
            
            # Û³. ØªØ³Øª Ø³Ù„Ø§Ù…Øª
            echo "ğŸ¥ Testing health..."
            response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" "$SERVICE_URL/api/health/ping")
            http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d':' -f2)
            
            if [ "$http_status" -eq 200 ]; then
              echo "âœ… Auto-recovery successful on attempt $attempt!"
              recovery_successful=true
              
              # Ø§Ø±Ø³Ø§Ù„ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…ÙˆÙÙ‚ÛŒØª
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
                -d chat_id="$TELEGRAM_CHAT_ID" \
                -d text="ğŸ”„ AUTO-RECOVERY SUCCESSFUL!%0AğŸ’» Vortex AI Service%0Aâœ… Recovered on attempt $attempt%0AğŸ› ï¸ Actions: Cache cleared, Systems reset%0AğŸ•’ Time: $(date +'%H:%M:%S')%0AğŸ‰ Service is back online!"
              break
            else
              echo "âŒ Recovery attempt $attempt failed (HTTP $http_status)"
              sleep 5  # ØµØ¨Ø± Ú©Ù† Ù‚Ø¨Ù„ Ø§Ø² ØªÙ„Ø§Ø´ Ø¨Ø¹Ø¯ÛŒ
            fi
          done
          
          if [ "$recovery_successful" = false ]; then
            echo "ğŸ’¥ All recovery attempts failed!"
            
            # Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ø®Ø·Ø§ÛŒ Ù…ÙØµÙ„
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸ”´ CRITICAL: AUTO-RECOVERY FAILED!%0AğŸ’» Vortex AI Service%0AâŒ All $max_retries recovery attempts failed%0AğŸš¨ Service remains unavailable%0Aâ° Failure Time: $(date +'%Y-%m-%d %H:%M:%S')%0AğŸ“ Immediate manual intervention required!"
            
            exit 1
          fi

      - name: ğŸ‰ Send Success Notification
        if: success()
        run: |
          echo "âœ… All health checks passed"
          
          # ÙÙ‚Ø· Ø§ÙˆÙ„ÛŒÙ† Ø§Ø¬Ø±Ø§ÛŒ ØµØ¨Ø­ Ú¯Ø²Ø§Ø±Ø´ Ù…ÙˆÙÙ‚ÛŒØª Ø¨ÙØ±Ø³Øª
          if [ $(date +%H) -eq 09 ] && [ $(date +%M) -lt 10 ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="âœ… VORTEX AI - ALL SYSTEMS GO!%0AğŸ’» Service Status: Healthy & Responsive%0AğŸ“Š Monitoring: Active%0AğŸ•’ Last Check: $(date +'%H:%M')%0AğŸ‰ Automated systems operational!"
          fi

      - name: ğŸ“Š Generate Weekly Report
        if: success() && github.event_name == 'schedule'
        run: |
          # ÙÙ‚Ø· Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¯ÙˆØ´Ù†Ø¨Ù‡ Ø³Ø§Ø¹Øª Û±Û° ØµØ¨Ø­
          if [ $(date +%u) -eq 1 ] && [ $(date +%H) -eq 10 ]; then
            echo "ğŸ“ˆ Generating weekly report..."
            
            # Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´
            weekly_data=$(curl -s "$SERVICE_URL/api/health/debug/reports/performance?days=7") || weekly_data="{}"
            
            # Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø²Ø§Ø±Ø´
            report_text="ğŸ“Š VORTEX AI - WEEKLY REPORT%0AGenerated: $(date +'%Y-%m-%d %H:%M')%0A%0AğŸ“ˆ PERFORMANCE METRICS:%0A- Average Health Score: $(echo "$weekly_data" | grep -o '"avg_health_score":[0-9.]*' | cut -d':' -f2 || echo "N/A")%%0A- Total Requests: $(echo "$weekly_data" | grep -o '"total_requests":[0-9]*' | cut -d':' -f2 || echo "N/A")%0A- Success Rate: $(echo "$weekly_data" | grep -o '"success_rate":[0-9.]*' | cut -d':' -f2 || echo "N/A")%%0A%0AğŸ’¾ RESOURCE USAGE:%0A- Peak CPU: $(echo "$weekly_data" | grep -o '"peak_cpu":[0-9.]*' | cut -d':' -f2 || echo "N/A")%%0A- Avg Memory: $(echo "$weekly_data" | grep -o '"avg_memory":[0-9.]*' | cut -d':' -f2 || echo "N/A")%%0A%0AğŸ¯ STATUS: Automated monitoring active"

            # Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$report_text"
            
            echo "âœ… Weekly report sent to Telegram"
          fi
