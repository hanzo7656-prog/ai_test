name: ğŸš€ Keep Render Service Alive

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

env:
  SERVICE_URL: ${{ secrets.SERVICE_URL }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Check Basic Health
        run: |
          echo "ğŸ• Starting health check at $(date)"
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" "$SERVICE_URL/api/health/ping")
          http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d':' -f2)
          
          if [ "$http_status" -eq 200 ]; then
            echo "âœ… Basic health check passed"
          else
            echo "âŒ Basic health check failed: HTTP $http_status"
            exit 1
          fi

      - name: ğŸ“Š Check Full Health Status
        run: |
          echo "ğŸ” Checking full health status..."
          
          status_response=$(curl -s "$SERVICE_URL/api/health/status")
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø§Ø² JSON
          health_score=$(echo "$status_response" | grep -o '"health_score":[0-9]*' | head -1 | cut -d':' -f2)
          overall_status=$(echo "$status_response" | grep -o '"status":"[^"]*' | head -1 | cut -d'"' -f4)
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù†Ø§Ø¨Ø¹ Ø§Ø² Ø¨Ø®Ø´ resources
          cpu_usage=$(echo "$status_response" | grep -o '"cpu":{"usage_percent":[0-9.]*' | cut -d':' -f3)
          memory_usage=$(echo "$status_response" | grep -o '"memory":{"usage_percent":[0-9.]*' | cut -d':' -f3)
          disk_usage=$(echo "$status_response" | grep -o '"disk":{"usage_percent":[0-9.]*' | cut -d':' -f3)
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
          cache_status=$(echo "$status_response" | grep -o '"cache_system":{"status":"[^"]*' | cut -d'"' -f4)
          cache_hit_rate=$(echo "$status_response" | grep -o '"hit_rate":[0-9]*' | cut -d':' -f2)
          redis_status=$(echo "$status_response" | grep -o '"redis":{"status":"[^"]*' | cut -d'"' -f4)
          api_status=$(echo "$status_response" | grep -o '"external_apis":{"status":"[^"]*' | cut -d'"' -f4)
          
          echo "âœ… Full health check passed"
          echo "ğŸ“ˆ Health Score: $health_score"
          echo "ğŸ”„ Overall Status: $overall_status"
          echo "âš¡ CPU: ${cpu_usage}%"
          echo "ğŸ§  Memory: ${memory_usage}%"
          echo "ğŸ’½ Disk: ${disk_usage}%"
          echo "ğŸ“¦ Cache: $cache_status (Hit Rate: ${cache_hit_rate}%)"
          echo "ğŸ”´ Redis: $redis_status"
          echo "ğŸŒ API: $api_status"
          
          # Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
          if [ "$health_score" -lt 70 ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸ”´ SYSTEM CRITICAL%0AğŸ’» Vortex AI Service%0A%0AğŸ“Š HEALTH: $health_score%%0Aâš¡ CPU: ${cpu_usage}%%0AğŸ§  MEMORY: ${memory_usage}%%0AğŸ’½ DISK: ${disk_usage}%%0A%0AğŸ”§ COMPONENTS%0AğŸ“¦ Cache: $cache_status%0AğŸ”´ Redis: $redis_status%0AğŸŒ API: $api_status%0A%0Aâ° $(date +'%H:%M')%0AğŸš¨ Immediate action required!"
          elif [ "$health_score" -lt 85 ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸŸ¡ SYSTEM WARNING%0AğŸ’» Vortex AI Service%0A%0AğŸ“Š HEALTH: $health_score%%0Aâš¡ CPU: ${cpu_usage}%%0AğŸ§  MEMORY: ${memory_usage}%%0AğŸ’½ DISK: ${disk_usage}%%0A%0Aâ° $(date +'%H:%M')%0Aâš ï¸ Monitor closely"
          else
            # ÙÙ‚Ø· Ø³Ø§Ø¹Øª Û¹ ØµØ¨Ø­ Ú¯Ø²Ø§Ø±Ø´ Ø³Ù„Ø§Ù…Øª Ø¨ÙØ±Ø³Øª
            if [ $(date +%H) -eq 09 ] && [ $(date +%M) -lt 10 ]; then
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
                -d chat_id="$TELEGRAM_CHAT_ID" \
                -d text="ğŸŸ¢ SYSTEM OPTIMAL%0AğŸ’» Vortex AI Service%0A%0AğŸ“Š HEALTH: $health_score%%0Aâš¡ CPU: ${cpu_usage}%%0AğŸ§  MEMORY: ${memory_usage}%%0AğŸ’½ DISK: ${disk_usage}%%0A%0Aâ° $(date +'%H:%M')%0Aâœ… All systems normal"
            fi
          fi

      - name: ğŸ’¾ Smart Resource Management
        run: |
          echo "ğŸ§  Smart resource management..."
          
          status_response=$(curl -s "$SERVICE_URL/api/health/status")
          memory_usage=$(echo "$status_response" | grep -o '"memory":{"usage_percent":[0-9.]*' | cut -d':' -f3)
          disk_usage=$(echo "$status_response" | grep -o '"disk":{"usage_percent":[0-9.]*' | cut -d':' -f3)
          cache_hit_rate=$(echo "$status_response" | grep -o '"hit_rate":[0-9]*' | cut -d':' -f2)
          
          echo "ğŸ§  Memory: ${memory_usage}%"
          echo "ğŸ’½ Disk: ${disk_usage}%"
          echo "ğŸ“¦ Cache Hit Rate: ${cache_hit_rate}%"
          
          # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­
          memory_int=$(echo "$memory_usage" | cut -d'.' -f1)
          disk_int=$(echo "$disk_usage" | cut -d'.' -f1)
          
          # Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§ÙØ¸Ù‡ - Ø§Ú¯Ø± Ø¨Ø§Ù„Ø§ÛŒ Û·ÛµÙª Ø¨ÙˆØ¯
          if [ -n "$memory_int" ] && [ "$memory_int" -gt 75 ]; then
            echo "âš ï¸ High memory usage detected - clearing cache..."
            curl -X POST "$SERVICE_URL/api/health/cache/clear" || true
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸ§¹ MEMORY CLEANUP%0AğŸ’» Vortex AI Service%0AğŸ§  Memory: ${memory_usage}%%0AğŸ“¦ Cache cleared%0Aâ° $(date +'%H:%M')%0Aâœ… System optimized"
          fi
          
          # Ù‡Ø´Ø¯Ø§Ø± Ø¯ÛŒØ³Ú© - Ø§Ú¯Ø± Ø¨Ø§Ù„Ø§ÛŒ Û¸Û°Ùª Ø¨ÙˆØ¯
          if [ -n "$disk_int" ] && [ "$disk_int" -gt 80 ]; then
            echo "ğŸš¨ High disk usage detected: ${disk_usage}%"
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸš¨ HIGH DISK USAGE%0AğŸ’» Vortex AI Service%0AğŸ’½ Disk: ${disk_usage}%%0AğŸ”´ Cleanup needed%0Aâ° $(date +'%H:%M')%0Aâš ï¸ Check logs & files"
          fi
          
          # Ø§Ú¯Ø± cache hit rate Ù¾Ø§ÛŒÛŒÙ† Ø¨ÙˆØ¯
          if [ -n "$cache_hit_rate" ] && [ "$cache_hit_rate" -lt 20 ]; then
            echo "âš ï¸ Low cache hit rate: ${cache_hit_rate}%"
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸ“Š CACHE PERFORMANCE%0AğŸ’» Vortex AI Service%0AğŸ“¦ Hit Rate: ${cache_hit_rate}%%0AğŸ”§ Optimization needed%0Aâ° $(date +'%H:%M')"
          fi

      - name: ğŸ” Performance Analysis
        run: |
          echo "ğŸ“ˆ Performance analysis..."
          
          status_response=$(curl -s "$SERVICE_URL/api/health/status")
          response_time=$(echo "$status_response" | grep -o '"response_time_ms":[0-9.]*' | cut -d':' -f2)
          uptime_seconds=$(echo "$status_response" | grep -o '"uptime_seconds":[0-9]*' | cut -d':' -f2)
          total_requests=$(echo "$status_response" | grep -o '"total_requests_processed":[0-9]*' | cut -d':' -f2)
          
          # ØªØ¨Ø¯ÛŒÙ„ uptime Ø¨Ù‡ Ø±ÙˆØ² Ùˆ Ø³Ø§Ø¹Øª
          uptime_days=$((uptime_seconds / 86400))
          uptime_hours=$(( (uptime_seconds % 86400) / 3600 ))
          
          echo "â±ï¸ Response Time: ${response_time}ms"
          echo "ğŸ“… Uptime: ${uptime_days}d ${uptime_hours}h"
          echo "ğŸ“Š Total Requests: ${total_requests}"
          
          # Ø§Ú¯Ø± response time Ø¨Ø§Ù„Ø§Ø³Øª
          response_int=$(echo "$response_time" | cut -d'.' -f1)
          if [ -n "$response_int" ] && [ "$response_int" -gt 2000 ]; then
            echo "ğŸŒ High response time detected: ${response_time}ms"
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸŒ PERFORMANCE ISSUE%0AğŸ’» Vortex AI Service%0Aâ±ï¸ Response Time: ${response_time}ms%0AğŸ”§ Optimization needed%0Aâ° $(date +'%H:%M')"
          fi

      - name: ğŸ›¡ï¸ Advanced Auto Recovery
        if: failure()
        run: |
          echo "ğŸš¨ Starting auto-recovery sequence..."
          max_retries=3
          recovery_successful=false
          
          for attempt in $(seq 1 $max_retries); do
            echo "ğŸ”„ Recovery attempt $attempt of $max_retries..."
            
            # Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ú©Ø´
            curl -s -X POST "$SERVICE_URL/api/health/cache/clear" || true
            sleep 2
            
            # Ø±ÛŒØ³Øª Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§
            curl -s -X POST "$SERVICE_URL/api/health/normalization/reset-metrics" || true
            sleep 3
            
            # ØªØ³Øª Ø³Ù„Ø§Ù…Øª
            response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" "$SERVICE_URL/api/health/ping")
            http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d':' -f2)
            
            if [ "$http_status" -eq 200 ]; then
              echo "âœ… Auto-recovery successful on attempt $attempt!"
              recovery_successful=true
              
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
                -d chat_id="$TELEGRAM_CHAT_ID" \
                -d text="ğŸ”„ AUTO-RECOVERY SUCCESSFUL%0AğŸ’» Vortex AI Service%0Aâœ… Recovered on attempt $attempt%0AğŸ› ï¸ Cache cleared & systems reset%0Aâ° $(date +'%H:%M:%S')%0AğŸ‰ Service restored!"
              break
            else
              echo "âŒ Recovery attempt $attempt failed (HTTP $http_status)"
              sleep 5
            fi
          done
          
          if [ "$recovery_successful" = false ]; then
            echo "ğŸ’¥ All recovery attempts failed!"
            
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="ğŸ”´ CRITICAL RECOVERY FAILURE%0AğŸ’» Vortex AI Service%0AâŒ All $max_retries recovery attempts failed%0AğŸš¨ Service remains offline%0Aâ° $(date +'%H:%M:%S')%0AğŸ“ Manual intervention required!"
            
            exit 1
          fi

      - name: ğŸ“ˆ Weekly Performance Report
        if: success() && github.event_name == 'schedule'
        run: |
          if [ $(date +%u) -eq 1 ] && [ $(date +%H) -eq 10 ]; then
            echo "ğŸ“Š Generating weekly performance report..."
            
            status_response=$(curl -s "$SERVICE_URL/api/health/status")
            health_score=$(echo "$status_response" | grep -o '"health_score":[0-9]*' | head -1 | cut -d':' -f2)
            memory_usage=$(echo "$status_response" | grep -o '"memory":{"usage_percent":[0-9.]*' | cut -d':' -f3)
            disk_usage=$(echo "$status_response" | grep -o '"disk":{"usage_percent":[0-9.]*' | cut -d':' -f3)
            uptime_seconds=$(echo "$status_response" | grep -o '"uptime_seconds":[0-9]*' | cut -d':' -f2)
            total_requests=$(echo "$status_response" | grep -o '"total_requests_processed":[0-9]*' | cut -d':' -f2)
            
            uptime_days=$((uptime_seconds / 86400))
            
            report_text="ğŸ“ˆ WEEKLY SYSTEM REPORT%0AğŸ’» Vortex AI Service%0A%0AğŸ¥ SYSTEM HEALTH%0AğŸ“Š Health Score: ${health_score}%%0AğŸ§  Memory Usage: ${memory_usage}%%0AğŸ’½ Disk Usage: ${disk_usage}%%0A%0AğŸ“Š PERFORMANCE METRICS%0AğŸ“… Uptime: ${uptime_days} days%0AğŸ“ˆ Total Requests: ${total_requests}%0AğŸ›¡ï¸ Auto-Recovery: Enabled%0AğŸ“± Monitoring: Active%0A%0AğŸ¯ STATUS%0Aâœ… All systems operational%0AğŸ”’ Automated monitoring active%0A%0Aâ° Generated: $(date +'%Y-%m-%d %H:%M')"
            
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$report_text"
            
            echo "âœ… Weekly report sent"
          fi

      - name: âœ… Final Success Notification
        if: success()
        run: |
          echo "ğŸ‰ All health checks completed successfully"
          # Ù¾ÛŒØ§Ù… Ù†Ù‡Ø§ÛŒÛŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="âœ… MANUAL CHECK COMPLETE%0AğŸ’» Vortex AI Service%0AğŸ‰ All systems verified%0Aâ° $(date +'%H:%M')%0AğŸŸ¢ Ready for operation!"
          fi
